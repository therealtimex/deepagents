# Label PRs based on their titles.
#
# Uses conventional commit types AND scopes from PR titles to apply labels.
# File-based labeling is handled separately by pr_labeler_file.yml

name: "PR Title Labeler"

on:
  # Safe since we're not checking out or running the PR's code
  # Never check out the PR's head in a pull_request_target job
  pull_request_target:
    types: [opened, edited]

jobs:
  pr-title-labeler:
    name: "label"
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest

    steps:
      - name: Label PR based on title
        uses: bcoe/conventional-release-labels@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          type_labels: >-
            {
              "feat": "feature",
              "fix": "fix",
              "docs": "documentation",
              "style": "linting",
              "refactor": "refactor",
              "perf": "performance",
              "test": "tests",
              "build": "infra",
              "ci": "infra",
              "chore": "infra",
              "revert": "revert",
              "release": "release",
              "breaking": "breaking"
            }
          ignored_types: '[]'

      - name: Label PR based on scope
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;
            const match = title.match(/^\w+\(([^)]+)\)/);
            if (!match) return;

            const scopes = match[1].split(",").map(s => s.trim());

            const scopeToLabel = {
              "deepagents": "deepagents",
              "sdk": "deepagents",
              "deepagents-cli": "cli",
              "cli": "cli",
              "harbor": "harbor",
              "acp": "acp",
            };

            const labels = [...new Set(
              scopes.map(s => scopeToLabel[s]).filter(Boolean)
            )];

            if (labels.length === 0) return;

            const current = context.payload.pull_request.labels.map(l => l.name);
            const toAdd = labels.filter(l => !current.includes(l));

            if (toAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: toAdd,
              });
            }
