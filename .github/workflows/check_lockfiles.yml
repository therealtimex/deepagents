# Check that all uv.lock files are up-to-date
#
# Prevents PRs from being merged when lockfiles are out of sync with pyproject.toml

name: "üîí Check Lockfiles"

on:
  push:
    branches: [master]
  pull_request:
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check-lockfiles:
    name: "Verify uv.lock files"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: "üìã Checkout Code"
        uses: actions/checkout@v6

      - name: "üêç Set up Python + UV"
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"

      - name: "üîç Check all lockfiles"
        run: |
          set -e

          # Find all directories containing uv.lock
          lockfile_dirs=$(find . -name "uv.lock" -type f -exec dirname {} \; | sort)

          failed_dirs=""
          for dir in $lockfile_dirs; do
            echo "::group::Checking $dir"
            if ! uv lock --check --directory "$dir" 2>&1; then
              echo "::error file=$dir/uv.lock::Lockfile is out of sync. Run 'uv lock' in $dir"
              failed_dirs="$failed_dirs $dir"
            else
              echo "‚úÖ $dir/uv.lock is up-to-date"
            fi
            echo "::endgroup::"
          done

          if [ -n "$failed_dirs" ]; then
            echo ""
            echo "‚ùå The following lockfiles are out of sync with their pyproject.toml:"
            echo ""
            for dir in $failed_dirs; do
              echo "  - $dir/uv.lock"
            done
            echo ""
            echo "To fix, run these commands:"
            echo ""
            for dir in $failed_dirs; do
              echo "  uv lock --directory $dir"
            done
            echo ""
            echo "Then commit the updated lockfile(s)."
            exit 1
          fi

          echo ""
          echo "‚úÖ All lockfiles are up-to-date!"
